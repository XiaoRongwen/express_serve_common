# ğŸš€ Rong Backend API éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨å®å¡”é¢æ¿ç¯å¢ƒä¸‹ä½¿ç”¨PM2éƒ¨ç½²Rong Backend APIæœåŠ¡ã€‚

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)
- [å‡†å¤‡å·¥ä½œ](#å‡†å¤‡å·¥ä½œ)
- [å¿«é€Ÿéƒ¨ç½²](#å¿«é€Ÿéƒ¨ç½²)
- [æ‰‹åŠ¨éƒ¨ç½²](#æ‰‹åŠ¨éƒ¨ç½²)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [å¸¸ç”¨å‘½ä»¤](#å¸¸ç”¨å‘½ä»¤)
- [ç›‘æ§å’Œç»´æŠ¤](#ç›‘æ§å’Œç»´æŠ¤)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## ğŸ”§ ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (æ¨è Ubuntu 18.04+, CentOS 7+)
- **Node.js**: v18.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **æ•°æ®åº“**: MySQL 5.7+ æˆ– 8.0+
- **å†…å­˜**: è‡³å°‘ 1GB RAM
- **å­˜å‚¨**: è‡³å°‘ 2GB å¯ç”¨ç©ºé—´
- **å®å¡”é¢æ¿**: 7.0+ ç‰ˆæœ¬

## ğŸ“¦ å‡†å¤‡å·¥ä½œ

### 1. å®‰è£…Node.js

åœ¨å®å¡”é¢æ¿ä¸­å®‰è£…Node.jsï¼š

1. è¿›å…¥å®å¡”é¢æ¿ â†’ è½¯ä»¶å•†åº—
2. æœç´¢å¹¶å®‰è£… "Node.jsç‰ˆæœ¬ç®¡ç†å™¨"
3. å®‰è£…Node.js 18.xç‰ˆæœ¬

æˆ–è€…é€šè¿‡å‘½ä»¤è¡Œå®‰è£…ï¼š

```bash
# ä½¿ç”¨NodeSourceä»“åº“å®‰è£…Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# éªŒè¯å®‰è£…
node -v
npm -v
```

### 2. å®‰è£…PM2

```bash
# å…¨å±€å®‰è£…PM2
npm install -g pm2

# éªŒè¯å®‰è£…
pm2 -v
```

### 3. å‡†å¤‡æ•°æ®åº“

åœ¨å®å¡”é¢æ¿ä¸­åˆ›å»ºMySQLæ•°æ®åº“ï¼š

1. è¿›å…¥å®å¡”é¢æ¿ â†’ æ•°æ®åº“
2. åˆ›å»ºæ–°æ•°æ®åº“
3. è®°å½•æ•°æ®åº“åã€ç”¨æˆ·åã€å¯†ç 

## âš¡ å¿«é€Ÿéƒ¨ç½²

### ä½¿ç”¨è‡ªåŠ¨éƒ¨ç½²è„šæœ¬

1. **ä¸Šä¼ é¡¹ç›®æ–‡ä»¶**åˆ°æœåŠ¡å™¨ï¼ˆå»ºè®®è·¯å¾„ï¼š`/var/www/rong-backend`ï¼‰

2. **é…ç½®ç¯å¢ƒå˜é‡**ï¼š
   ```bash
   # å¤åˆ¶ç¯å¢ƒé…ç½®æ¨¡æ¿
   cp env.production .env
   
   # ç¼–è¾‘ç¯å¢ƒé…ç½®
   nano .env
   ```

3. **è¿è¡Œéƒ¨ç½²è„šæœ¬**ï¼š
   ```bash
   # ç»™è„šæœ¬æ‰§è¡Œæƒé™
   chmod +x deploy.sh
   
   # æ‰§è¡Œéƒ¨ç½²
   ./deploy.sh
   ```

éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ“ä½œï¼š
- âœ… æ£€æŸ¥Node.jså’ŒPM2ç¯å¢ƒ
- âœ… å®‰è£…é¡¹ç›®ä¾èµ–
- âœ… æ„å»ºTypeScripté¡¹ç›®
- âœ… è®¾ç½®æ•°æ®åº“
- âœ… åˆ›å»ºå¿…è¦ç›®å½•
- âœ… å¯åŠ¨PM2æœåŠ¡

## ğŸ”¨ æ‰‹åŠ¨éƒ¨ç½²

å¦‚æœéœ€è¦æ‰‹åŠ¨æ§åˆ¶éƒ¨ç½²è¿‡ç¨‹ï¼š

### 1. é¡¹ç›®å‡†å¤‡

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/rong-backend

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºé¡¹ç›®
npm run build

# ç”ŸæˆPrismaå®¢æˆ·ç«¯
npm run db:generate
```

### 2. ç¯å¢ƒé…ç½®

```bash
# å¤åˆ¶å¹¶ç¼–è¾‘ç¯å¢ƒé…ç½®
cp env.production .env
nano .env

# ä¸»è¦é…ç½®é¡¹ï¼š
# - DATABASE_URL: æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
# - JWT_SECRET: JWTå¯†é’¥
# - CORS_ORIGIN: å‰ç«¯åŸŸå
# - PORT: æœåŠ¡ç«¯å£
```

### 3. æ•°æ®åº“è®¾ç½®

```bash
# æ¨é€æ•°æ®åº“æ¶æ„ï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰
npm run db:push

# æˆ–è€…ä½¿ç”¨è¿ç§»ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
npx prisma migrate deploy
```

### 4. åˆ›å»ºç›®å½•

```bash
# åˆ›å»ºæ—¥å¿—å’Œä¸Šä¼ ç›®å½•
mkdir -p logs uploads

# è®¾ç½®æƒé™
chmod -R 755 uploads/ logs/
```

### 5. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨PM2å¯åŠ¨
npm run pm2:start:prod

# ä¿å­˜PM2é…ç½®
pm2 save

# è®¾ç½®PM2å¼€æœºè‡ªå¯
pm2 startup
```

## âš™ï¸ é…ç½®è¯´æ˜

### PM2é…ç½® (ecosystem.config.js)

```javascript
module.exports = {
  apps: [{
    name: 'rong-backend-api',
    script: 'dist/index.js',
    instances: 'max',        // ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
    exec_mode: 'cluster',    // é›†ç¾¤æ¨¡å¼
    max_memory_restart: '1G', // å†…å­˜é™åˆ¶
    autorestart: true,       // è‡ªåŠ¨é‡å¯
    watch: false,           // ç”Ÿäº§ç¯å¢ƒå…³é—­æ–‡ä»¶ç›‘å¬
    env_production: {
      NODE_ENV: 'production',
      PORT: 4000
    }
  }]
};
```

### ç¯å¢ƒå˜é‡é…ç½®

å…³é”®é…ç½®é¡¹è¯´æ˜ï¼š

| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `DATABASE_URL` | æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² | `mysql://user:pass@localhost:3306/db` |
| `JWT_SECRET` | JWTå¯†é’¥ï¼ˆ64å­—ç¬¦ä»¥ä¸Šï¼‰ | `your-super-secret-key...` |
| `CORS_ORIGIN` | å…è®¸çš„å‰ç«¯åŸŸå | `https://your-domain.com` |
| `PORT` | æœåŠ¡ç«¯å£ | `4000` |
| `REDIS_URL` | Redisè¿æ¥ï¼ˆå¯é€‰ï¼‰ | `redis://localhost:6379` |

## ğŸ“ å¸¸ç”¨å‘½ä»¤

### PM2ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
npm run pm2:status

# æŸ¥çœ‹æ—¥å¿—
npm run pm2:logs

# é‡å¯æœåŠ¡
npm run pm2:restart

# åœæ­¢æœåŠ¡
npm run pm2:stop

# åˆ é™¤æœåŠ¡
npm run pm2:delete

# ç›‘æ§é¢æ¿
npm run pm2:monit
```

### åº”ç”¨ç®¡ç†å‘½ä»¤

```bash
# æ„å»ºé¡¹ç›®
npm run build

# æ•°æ®åº“æ“ä½œ
npm run db:generate  # ç”ŸæˆPrismaå®¢æˆ·ç«¯
npm run db:push      # æ¨é€æ•°æ®åº“æ¶æ„
npm run db:studio    # æ‰“å¼€æ•°æ®åº“ç®¡ç†ç•Œé¢

# éƒ¨ç½²ç›¸å…³
npm run deploy       # å®Œæ•´éƒ¨ç½²æµç¨‹
npm run deploy:prod  # å¿«é€Ÿç”Ÿäº§éƒ¨ç½²
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 1. æ—¥å¿—ç®¡ç†

æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼š
- ç»¼åˆæ—¥å¿—: `logs/combined.log`
- è¾“å‡ºæ—¥å¿—: `logs/out.log`
- é”™è¯¯æ—¥å¿—: `logs/error.log`

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f logs/combined.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f logs/error.log

# PM2æ—¥å¿—
pm2 logs rong-backend-api --lines 100
```

### 2. æ€§èƒ½ç›‘æ§

```bash
# PM2ç›‘æ§é¢æ¿
pm2 monit

# æŸ¥çœ‹è¿›ç¨‹è¯¦æƒ…
pm2 show rong-backend-api

# ç³»ç»Ÿèµ„æºä½¿ç”¨
htop
```

### 3. å¥åº·æ£€æŸ¥

åº”ç”¨æä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š

```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸
curl http://localhost:4000/health

# é¢„æœŸå“åº”
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "uptime": 3600
}
```

## ğŸ”§ å®å¡”é¢æ¿é…ç½®

### 1. åå‘ä»£ç†è®¾ç½®

åœ¨å®å¡”é¢æ¿ä¸­é…ç½®Nginxåå‘ä»£ç†ï¼š

1. è¿›å…¥ç½‘ç«™ç®¡ç† â†’ é€‰æ‹©åŸŸå â†’ åå‘ä»£ç†
2. æ·»åŠ åå‘ä»£ç†ï¼š
   - ä»£ç†åç§°: `rong-backend-api`
   - ç›®æ ‡URL: `http://127.0.0.1:4000`
   - å‘é€åŸŸå: `$host`

### 2. SSLè¯ä¹¦é…ç½®

1. è¿›å…¥ç½‘ç«™ç®¡ç† â†’ SSL
2. ç”³è¯·Let's Encryptå…è´¹è¯ä¹¦
3. å¼ºåˆ¶HTTPSè®¿é—®

### 3. é˜²ç«å¢™è®¾ç½®

ç¡®ä¿å¼€æ”¾å¿…è¦ç«¯å£ï¼š
- HTTP: 80
- HTTPS: 443
- åº”ç”¨ç«¯å£: 4000ï¼ˆå†…éƒ¨è®¿é—®ï¼‰

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æ£€æŸ¥æ—¥å¿—
pm2 logs rong-backend-api

# å¸¸è§åŸå› ï¼š
# - ç«¯å£è¢«å ç”¨
# - æ•°æ®åº“è¿æ¥å¤±è´¥
# - ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯
```

#### 2. æ•°æ®åº“è¿æ¥é—®é¢˜

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
npm run db:studio

# æ£€æŸ¥é…ç½®
echo $DATABASE_URL
```

#### 3. å†…å­˜ä¸è¶³

```bash
# æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h

# è°ƒæ•´PM2é…ç½®
# åœ¨ecosystem.config.jsä¸­è®¾ç½®ï¼š
# max_memory_restart: '512M'
```

#### 4. æ–‡ä»¶æƒé™é—®é¢˜

```bash
# è®¾ç½®æ­£ç¡®æƒé™
sudo chown -R www-data:www-data /var/www/rong-backend
chmod -R 755 uploads/ logs/
```

### æ—¥å¿—åˆ†æ

#### æŸ¥çœ‹é”™è¯¯æ—¥å¿—
```bash
# PM2é”™è¯¯æ—¥å¿—
pm2 logs rong-backend-api --err

# åº”ç”¨é”™è¯¯æ—¥å¿—
tail -f logs/error.log | grep ERROR
```

#### æ€§èƒ½é—®é¢˜æ’æŸ¥
```bash
# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
pm2 show rong-backend-api

# å†…å­˜ä½¿ç”¨æƒ…å†µ
ps aux | grep node

# ç½‘ç»œè¿æ¥
netstat -tulpn | grep :4000
```

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### ä»£ç æ›´æ–°æµç¨‹

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. å®‰è£…æ–°ä¾èµ–
npm install

# 3. æ„å»ºé¡¹ç›®
npm run build

# 4. æ›´æ–°æ•°æ®åº“ï¼ˆå¦‚æœ‰å˜æ›´ï¼‰
npm run db:push

# 5. é‡å¯æœåŠ¡
npm run pm2:reload
```

### é›¶åœæœºæ›´æ–°

```bash
# ä½¿ç”¨PM2 reloadå®ç°é›¶åœæœºæ›´æ–°
pm2 reload rong-backend-api

# æˆ–ä½¿ç”¨è„šæœ¬
./deploy.sh
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **ç³»ç»Ÿè¦æ±‚**æ˜¯å¦æ»¡è¶³
2. **ç¯å¢ƒå˜é‡**æ˜¯å¦æ­£ç¡®é…ç½®
3. **æ•°æ®åº“è¿æ¥**æ˜¯å¦æ­£å¸¸
4. **ç«¯å£**æ˜¯å¦è¢«å ç”¨
5. **æƒé™**æ˜¯å¦æ­£ç¡®è®¾ç½®

æ›´å¤šé—®é¢˜è¯·æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£æˆ–æäº¤Issueã€‚

---

**éƒ¨ç½²å®Œæˆåï¼Œè®°å¾—ï¼š**
- âœ… æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹
- âœ… éªŒè¯æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
- âœ… æ£€æŸ¥æ—¥å¿—è¾“å‡º
- âœ… è®¾ç½®ç›‘æ§å‘Šè­¦
- âœ… å¤‡ä»½æ•°æ®åº“

ç¥æ‚¨éƒ¨ç½²é¡ºåˆ©ï¼ğŸ‰
